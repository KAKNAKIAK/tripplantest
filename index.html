<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î™®Î∞îÏùº Ï∂îÏ≤úÏùºÏ†ïÌëú ÎßåÎì§Í∏∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #F8F9FA;
        }
        .header {
            background-color: white;
            border-bottom: 1px solid #E0E0E0;
        }
        .header-title-container {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* 8px */
        }
        .header-title-input {
            font-size: 1.5rem; /* text-2xl */
            font-weight: bold;
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            border: 1px solid #D1D5DB; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            flex-grow: 1;
            min-width: 200px;
        }
        .action-button {
            padding: 8px 12px; 
            font-size: 0.875rem; 
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem; 
        }
        .action-button:hover {
            filter: brightness(0.95);
        }
        .day-section {
            margin-bottom: 16px; 
            border: 1px solid transparent; /* For sortable ghost */
            border-radius: 0.375rem; /* rounded-md */
        }
        .day-section.sortable-ghost {
            background-color: #e0e7ff; /* Light blue for ghost */
            border: 1px dashed #6366f1; /* Indigo border for ghost */
        }
         .day-section.sortable-chosen { /* Style for the item being dragged */
            opacity: 0.7;
        }

        .day-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px; 
            border-bottom: 1px solid #EEE;
            margin-bottom: 16px;
            background-color: #fdfdfd;
            border-radius: 6px 6px 0 0;
            cursor: grab; /* Indicate day section is draggable */
        }
        .day-header-main { 
            display: flex;
            align-items: center;
            gap: 8px; 
            flex-grow: 1;
        }
        .day-header-title {
            font-size: 18px;
            font-weight: 600; 
            /* cursor: pointer; No longer needed for collapse, header container is clickable */
        }
        .date-edit-input {
            font-size: 16px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-width: 180px; 
        }
        .day-header-controls { 
             display: flex;
             align-items: center;
             gap: 2px; /* Further reduced gap for more buttons */
        }
        .icon-button { /* General style for icon buttons */
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-button:hover {
            background-color: #e0e0e0;
        }
        .icon-button svg {
            width: 20px;
            height: 20px;
            color: #555; /* Default icon color */
        }
        .icon-button.delete-day-button svg { 
            color: #ef4444; 
        }
        .icon-button.delete-day-button:hover svg {
            color: #dc2626; 
        }
        .card-action-icon-button svg { /* Specific size for card action icons */
            width: 18px;
            height: 18px;
        }
        .card-action-icon-button.delete-activity-button svg {
            color: #ef4444; /* Red for delete */
        }
         .card-action-icon-button.delete-activity-button:hover svg {
            color: #dc2626; /* Darker red on hover */
        }


        .day-toggle-button svg {
            transition: transform 0.2s ease-in-out;
        }
        .day-content-wrapper {
            padding-left: 8px; 
            padding-right: 8px;
        }
        .activity-card {
            background-color: white;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
            padding: 16px;
            margin-bottom: 16px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            cursor: grab; 
        }
        .readonly-activity-card { 
            background-color: white;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
            padding: 16px;
            margin-bottom: 16px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
        }
        .activity-card:active {
            cursor: grabbing;
        }
        .card-time-icon-area {
            width: 100px; 
            flex-shrink: 0;
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
        }
        .card-icon { 
            font-size: 24px;
            margin-bottom: 4px; 
        }
        .card-time { 
            font-size: 14px;
            font-weight: bold;
            min-height: 21px; 
        }
        .card-details-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 4px; 
        }
        .card-title {
            font-size: 16px;
            font-weight: bold;
        }
        .card-description, .card-location, .card-cost, .card-notes {
            font-size: 14px;
        }
        .card-image {
            width: 400px;   
            height: 400px;  
            object-fit: cover; 
            border-radius: 4px;
            margin-top: 8px;
        }
        .card-location a {
            color: #007bff;
            text-decoration: none;
        }
        .card-location a:hover {
            text-decoration: underline;
        }
        .card-actions-direct { 
            display: flex;
            flex-direction: row; 
            align-items: center; 
            gap: 0.5rem; 
            margin-left: auto; 
            padding-left: 0.5rem; 
        }
        
        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content { 
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px; 
            max-height: 90vh;
            overflow-y: auto;
        }
        .confirm-modal-content { 
             max-width: 400px; 
        }
        .modal-content label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%;
            padding: 8px; 
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 12px;
            background-color: white; 
            height: 40px; 
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }

        /* Print Styles & Read-only HTML View Styles */
        .readonly-view-header { 
            background-color: white;
            border-bottom: 1px solid #E0E0E0;
            padding: 1rem; 
            text-align: center;
        }
        .readonly-view-header h1 {
            font-size: 1.5rem; 
            font-weight: bold;
        }
        .readonly-main-content {
            max-width: 48rem; 
            margin-left: auto;
            margin-right: auto;
            padding: 1rem; 
        }
        .readonly-collapse-button {
            font-size: 0.75rem; /* text-xs */
            color: #4B5563; /* gray-600 */
            padding: 0.25rem 0.5rem; /* py-1 px-2 */
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
        }
        .readonly-collapse-button:hover {
            color: #1F2937; /* gray-800 */
            background-color: #F3F4F6; /* gray-100 */
        }


        @media print, .saved-html-view { 
            .header, .add-day-button-container, .add-activity-button, #activityModal, #confirmDeleteDayModal, .day-toggle-button, .edit-date-button, .save-date-button, .cancel-date-edit-button, .delete-day-button, #saveHtmlButton, #loadHtmlButtonTrigger, .edit-trip-title-button, .save-trip-title-button, .cancel-trip-title-edit-button, .card-actions-direct, #loadDayHtmlButtonTrigger, .save-day-button, .load-day-at-index-button, #previewButton, #loadExcelButtonTrigger { display: none !important; }
            .main-content, .readonly-main-content { padding: 0 !important; }
            .day-section { margin-bottom: 15mm; page-break-inside: avoid; }
            .day-header-container { padding: 0; margin-bottom: 5mm; border-bottom: 2px solid black; background-color: white !important; cursor: default !important; }
            .day-header-title { font-size: 16pt; cursor: default !important; }
            .date-edit-input { display: none !important; }
            .day-content-wrapper { /* display: block !important; */ padding: 0 !important; } /* Keep hidden class effective */
            .activity-card, .readonly-activity-card { border: 1px solid #ccc; box-shadow: none; padding: 4mm; margin-bottom: 4mm; page-break-inside: avoid; display: flex !important; cursor: default !important; }
            .card-time-icon-area { width: 25mm; flex-direction: column; }
            .card-icon { font-size: 14pt; margin-bottom: 1mm; }
            .card-time { font-size: 10pt; font-weight: bold; min-height: 12pt; }
            .card-details-area { flex-grow: 1; }
            .card-title { font-size: 12pt; font-weight: bold; }
            .card-description, .card-location, .card-cost, .card-notes { font-size: 10pt; }
            .card-image { 
                display: block; 
                width: 80px !important; 
                height: 80px !important; 
                object-fit: cover !important; 
            } 
            .card-location a { text-decoration: none; color: black; }
            .card-location a::after { content: " (" attr(href) ")"; font-size: 8pt; } 
            @page { size: A4 portrait; margin: 20mm; @top-left { content: attr(data-trip-title); font-size: 9pt; color: #555; } @top-right { content: "Page " counter(page) " / " counter(pages); font-size: 9pt; color: #555; } @bottom-left { content: "ÏÉùÏÑ±Ïùº: " attr(data-creation-date); font-size: 9pt; color: #555; } @bottom-right { content: "MyTravelPlanner"; font-size: 9pt; color: #555; } }
            body::before { display: none; content: attr(data-trip-title) attr(data-creation-date); }
        }
        @media print { 
             .card-image { display: none; } 
             .readonly-collapse-button { display: none !important; } /* Hide collapse button in print */
        }

        .sortable-ghost { opacity: 0.4; background: #F0F8FF; }
        .sortable-drag { opacity: 0.9; }
    </style>
</head>
<body class="text-gray-800">

    <header class="header sticky top-0 z-50 py-3 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto flex justify-between items-center h-[60px]">
            <div id="headerTitleSection" class="header-title-container">
                </div>
            <div class="flex items-center space-x-2"> 
                <button id="previewButton" class="action-button bg-purple-500 text-white hover:bg-purple-600" title="ÎØ∏Î¶¨Î≥¥Í∏∞">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <span class="hidden sm:inline">ÎØ∏Î¶¨Î≥¥Í∏∞</span>
                </button>
                <button id="savePdfButton" class="action-button bg-blue-500 text-white hover:bg-blue-600" title="PDFÎ°ú Ï†ÄÏû•">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16"y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <span class="hidden sm:inline">PDF Ï†ÄÏû•</span>
                </button>
                <button id="saveHtmlButton" class="action-button bg-orange-500 text-white hover:bg-orange-600" title="HTML ÌååÏùºÎ°ú Ï†ÄÏû•">
                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13H7v8"></polyline><polyline points="7 3 7 8H3"></polyline></svg>
                    <span class="hidden sm:inline">HTML Ï†ÄÏû•</span>
                </button>
                <input type="file" id="loadHtmlInput" accept=".html" style="display: none;">
                <button id="loadHtmlButtonTrigger" class="action-button bg-yellow-500 text-white hover:bg-yellow-600" title="HTML ÌååÏùºÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <span class="hidden sm:inline">HTML Î∂àÎü¨Ïò§Í∏∞</span>
                </button>
                <input type="file" id="loadExcelInput" accept=".xlsx, .csv" style="display: none;">
                <button id="loadExcelButtonTrigger" class="action-button bg-green-500 text-white hover:bg-green-600" title="ÏóëÏÖÄ ÌååÏùºÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
                    <span class="hidden sm:inline">ÏóëÏÖÄ Î∂àÎü¨Ïò§Í∏∞</span>
                </button>
                </div>
        </div>
    </header>

    <main class="main-content max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div id="daysContainer" class="space-y-4"> 
            </div>

        <div class="add-day-button-container mt-6 text-center">
            <button id="addDayButton" class="action-button bg-indigo-500 text-white hover:bg-indigo-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                ÏÉà ÎÇ†Ïßú Ï∂îÍ∞Ä
            </button>
            <input type="file" id="loadDayAtIndexHtmlInput" accept=".html" style="display: none;">
        </div>
    </main>

    <div id="activityModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">ÏÉà ÏùºÏ†ï Ï∂îÍ∞Ä</h2>
            <form id="activityForm">
                <input type="hidden" id="activityId">
                <input type="hidden" id="dayIndex">
                <div>
                    <label for="activityTimeInput">ÏãúÍ∞Ñ (HHMM ÌòïÏãù, ÏÑ†ÌÉù ÏÇ¨Ìï≠):</label>
                    <input type="text" id="activityTimeInput" placeholder="Ïòà: 1130 ÎòêÎäî 0900" maxlength="4">
                </div>
                <div>
                    <label for="activityIconSelect">ÏïÑÏù¥ÏΩò ÏÑ†ÌÉù:</label> 
                    <select id="activityIconSelect"> </select>
                </div>
                <div>
                    <label for="activityTitle">ÌôúÎèô/Ïû•ÏÜåÎ™Ö:</label>
                    <input type="text" id="activityTitle" required placeholder="Ïòà: Î£®Î∏åÎ•¥ Î∞ïÎ¨ºÍ¥Ä Î∞©Î¨∏">
                </div>
                <div>
                    <label for="activityDescription">Í∞ÑÎã® ÏÑ§Î™Ö/Î©îÎ™®:</label>
                    <textarea id="activityDescription" rows="3" placeholder="Ïòà: Î™®ÎÇòÎ¶¨Ïûê Î∞è Ï£ºÏöî ÏûëÌíà Í¥ÄÎûå"></textarea>
                </div>
                <div>
                    <label for="activityLocation">Ï£ºÏÜå/ÏúÑÏπò ÎßÅÌÅ¨:</label>
                    <input type="url" id="activityLocation" placeholder="Ïòà: https://maps.google.com/... (ÏÑ†ÌÉù ÏÇ¨Ìï≠)">
                </div>
                <div>
                    <label for="activityImageUrl">Ïù¥ÎØ∏ÏßÄ URL:</label> 
                    <input type="url" id="activityImageUrl" placeholder="Ïòà: https://example.com/image.jpg (ÏÑ†ÌÉù ÏÇ¨Ìï≠)">
                </div>
                <div>
                    <label for="activityCost">ÎπÑÏö©:</label>
                    <input type="text" id="activityCost" placeholder="Ïòà: ‚Ç¨20 ÎòêÎäî ‚Ç©25,000 (ÏÑ†ÌÉù ÏÇ¨Ìï≠)">
                </div>
                <div>
                    <label for="activityNotes">Í∏∞ÌÉÄ ÌïÑÎìú (ÏòàÏïΩÎ≤àÌò∏ Îì±):</label>
                    <input type="text" id="activityNotes" placeholder="Ïòà: ÏòàÏïΩÎ≤àÌò∏: 12345 (ÏÑ†ÌÉù ÏÇ¨Ìï≠)">
                </div>
                <div class="modal-buttons">
                    <button type="button" id="cancelActivityButton" class="action-button bg-gray-300 hover:bg-gray-400">Ï∑®ÏÜå</button>
                    <button type="submit" id="saveActivityButton" class="action-button bg-green-500 text-white hover:bg-green-600">Ï†ÄÏû•</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmDeleteDayModal" class="modal-backdrop hidden">
        <div class="modal-content confirm-modal-content"> <h3 class="text-lg font-semibold mb-4">ÏùºÏ†ï ÏÇ≠Ï†ú ÌôïÏù∏</h3>
            <p id="confirmDeleteDayMessage" class="mb-6">Ï†ïÎßêÎ°ú Ïù¥ ÎÇ†ÏßúÏùò Î™®Îì† ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
            <div class="modal-buttons">
                <button id="cancelDeleteDayButton" class="action-button bg-gray-300 hover:bg-gray-400">ÏïÑÎãàÏò§</button>
                <button id="confirmDeleteDayActionButton" class="action-button bg-red-500 text-white hover:bg-red-600">Ïòà, ÏÇ≠Ï†úÌï©ÎãàÎã§</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-md shadow-lg transition-opacity duration-300 opacity-0">
        </div>

    <script>
        // --- Predefined Emojis ---
        const travelEmojis = [
            { value: "", display: "ÏïÑÏù¥ÏΩò ÏóÜÏùå" }, { value: "‚úàÔ∏è", display: "‚úàÔ∏è Ìï≠Í≥µ" }, { value: "üè®", display: "ÔøΩ ÏàôÏÜå" }, { value: "üçΩÔ∏è", display: "üçΩÔ∏è ÏãùÏÇ¨" }, { value: "üèõÔ∏è", display: "üèõÔ∏è Í¥ÄÍ¥ë(Ïã§ÎÇ¥)" }, { value: "üèûÔ∏è", display: "üèûÔ∏è Í¥ÄÍ¥ë(ÏïºÏô∏)" }, { value: "üö∂", display: "üö∂ Ïù¥Îèô(ÎèÑÎ≥¥)" }, { value: "üöå", display: "üöå Ïù¥Îèô(Î≤ÑÏä§)" }, { value: "üöÜ", display: "üöÜ Ïù¥Îèô(Í∏∞Ï∞®)" }, { value: "üö¢", display: "üö¢ Ïù¥Îèô(Î∞∞)" }, { value: "üöï", display: "üöï Ïù¥Îèô(ÌÉùÏãú)" }, { value: "üõçÔ∏è", display: "üõçÔ∏è ÏáºÌïë" }, { value: "üì∑", display: "üì∑ ÏÇ¨ÏßÑÏ¥¨ÏòÅ" }, { value: "üó∫Ô∏è", display: "üó∫Ô∏è Í≥ÑÌöç/ÏßÄÎèÑ" }, { value: "üìå", display: "üìå Ï§ëÏöîÏû•ÏÜå" }, { value: "‚òï", display: "‚òï Ïπ¥Ìéò/Ìú¥Ïãù" }, { value: "üé≠", display: "üé≠ Í≥µÏó∞/Î¨∏Ìôî" }, { value: "üíº", display: "üíº ÏóÖÎ¨¥" }, { value: "‚ÑπÔ∏è", display: "‚ÑπÔ∏è Ï†ïÎ≥¥" }
        ];

        // --- Data ---
        let tripData = {
            title: "Ïó¨Ìñâ ÏùºÏ†ïÌëú", 
            editingTitle: false, 
            days: [] 
        };

        // --- DOM Elements ---
        const headerTitleSection = document.getElementById('headerTitleSection'); 
        const daysContainer = document.getElementById('daysContainer');
        const addDayButton = document.getElementById('addDayButton');
        const activityModal = document.getElementById('activityModal');
        const modalTitle = document.getElementById('modalTitle');
        const activityForm = document.getElementById('activityForm');
        const activityIdInput = document.getElementById('activityId');
        const dayIndexInput = document.getElementById('dayIndex');
        const activityTimeInput = document.getElementById('activityTimeInput'); 
        const activityIconSelect = document.getElementById('activityIconSelect'); 
        const previewButton = document.getElementById('previewButton'); 
        const savePdfButton = document.getElementById('savePdfButton');
        const saveHtmlButton = document.getElementById('saveHtmlButton'); 
        const loadHtmlInput = document.getElementById('loadHtmlInput'); 
        const loadHtmlButtonTrigger = document.getElementById('loadHtmlButtonTrigger'); 
        const loadExcelInput = document.getElementById('loadExcelInput'); 
        const loadExcelButtonTrigger = document.getElementById('loadExcelButtonTrigger'); 
        const loadDayAtIndexHtmlInput = document.getElementById('loadDayAtIndexHtmlInput'); 
        const toast = document.getElementById('toast');
        const confirmDeleteDayModal = document.getElementById('confirmDeleteDayModal');
        const confirmDeleteDayMessage = document.getElementById('confirmDeleteDayMessage');
        const cancelDeleteDayButton = document.getElementById('cancelDeleteDayButton');
        const confirmDeleteDayActionButton = document.getElementById('confirmDeleteDayActionButton');
        let dayIndexToDelete = -1;
        let insertDayAtIndex = -1; 

        // --- Utility Functions ---
        function generateId() { return 'id_' + Math.random().toString(36).substr(2, 9); }
        function formatDate(dateString, dayNumber) { const date = new Date(dateString); const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }; return `DAY ${dayNumber}: ${date.toLocaleDateString('ko-KR', options)}`; }
        
        function formatTimeToHHMM(timeStr) { 
            if (timeStr && timeStr.length === 4 && /^\d{4}$/.test(timeStr)) {
                const hours = timeStr.substring(0, 2);
                const minutes = timeStr.substring(2, 4);
                if (parseInt(hours, 10) >= 0 && parseInt(hours, 10) <= 23 &&
                    parseInt(minutes, 10) >= 0 && parseInt(minutes, 10) <= 59) {
                    return `${hours}:${minutes}`;
                }
            }
            return ""; 
        }

        function populateIconDropdown() { activityIconSelect.innerHTML = ''; travelEmojis.forEach(emoji => { const option = document.createElement('option'); option.value = emoji.value; option.textContent = emoji.display; activityIconSelect.appendChild(option); });}
        function dateToYyyyMmDd(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        }
        
        // --- Icon SVGs ---
        const editIconSVG = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>`;
        const saveIconSVG = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
        const cancelIconSVG = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
        const duplicateIconSVG = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
        const deleteIconSVG = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
        const saveDayIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13H7v8"></polyline><polyline points="7 3 7 8H3"></polyline></svg>`;
        const loadDayAtIndexIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l.001-.001 8.49-8.48"></path><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>`; 


        // --- Rendering Functions for Main App ---
        function renderHeaderTitle() {
            headerTitleSection.innerHTML = ''; 
            if (tripData.editingTitle) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'header-title-input';
                input.value = tripData.title;
                input.id = 'tripTitleInput';

                const saveButton = document.createElement('button');
                saveButton.className = 'icon-button save-trip-title-button';
                saveButton.title = 'Ï†úÎ™© Ï†ÄÏû•';
                saveButton.innerHTML = saveIconSVG;
                saveButton.addEventListener('click', handleSaveTripTitle);

                const cancelButton = document.createElement('button');
                cancelButton.className = 'icon-button cancel-trip-title-edit-button';
                cancelButton.title = 'Ï∑®ÏÜå';
                cancelButton.innerHTML = cancelIconSVG;
                cancelButton.addEventListener('click', handleCancelTripTitleEdit);
                
                headerTitleSection.appendChild(input);
                headerTitleSection.appendChild(saveButton);
                headerTitleSection.appendChild(cancelButton);
                input.focus();
                input.select();

            } else {
                const titleH1 = document.createElement('h1');
                titleH1.className = 'text-2xl font-bold';
                titleH1.textContent = tripData.title;
                titleH1.id = 'tripTitleDisplay'; 

                const editButton = document.createElement('button');
                editButton.className = 'icon-button edit-trip-title-button';
                editButton.title = 'Ïó¨Ìñâ Ï†úÎ™© ÏàòÏ†ï';
                editButton.innerHTML = editIconSVG;
                editButton.addEventListener('click', handleEditTripTitle);

                headerTitleSection.appendChild(titleH1);
                headerTitleSection.appendChild(editButton);
            }
        }

        function renderTrip() {
            renderHeaderTitle(); 
            document.body.setAttribute('data-trip-title', tripData.title); 
            const creationDate = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\. /g, '-').replace('.', '');
            document.body.setAttribute('data-creation-date', creationDate); 

            daysContainer.innerHTML = ''; 
            tripData.days.forEach((day, dayIndex) => {
                const daySection = document.createElement('div');
                daySection.className = 'day-section bg-white shadow-sm rounded-md'; 
                daySection.dataset.dayId = `day-${dayIndex}`; 

                const expandedIcon = `<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                const collapsedIcon = `<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                const deleteDayIcon = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;

                let dateDisplayHTML;
                if (day.editingDate) {
                    dateDisplayHTML = `
                        <input type="date" class="date-edit-input" value="${day.date}" data-day-index="${dayIndex}">
                        <button class="save-date-button icon-button" data-day-index="${dayIndex}" title="ÎÇ†Ïßú Ï†ÄÏû•">${saveIconSVG}</button>
                        <button class="cancel-date-edit-button icon-button" data-day-index="${dayIndex}" title="Ï∑®ÏÜå">${cancelIconSVG}</button>
                    `;
                } else {
                    dateDisplayHTML = `
                        <h2 class="day-header-title" data-day-index="${dayIndex}">${formatDate(day.date, dayIndex + 1)}</h2>
                        <button class="edit-date-button icon-button" data-day-index="${dayIndex}" title="ÎÇ†Ïßú ÏàòÏ†ï">${editIconSVG}</button>
                    `;
                }

                daySection.innerHTML = `
                    <div class="day-header-container">
                        <div class="day-header-main">
                            ${dateDisplayHTML}
                        </div>
                        <div class="day-header-controls">
                            <button class="save-day-button icon-button" data-day-index="${dayIndex}" title="Ïù¥ ÎÇ†Ïßú HTMLÎ°ú Ï†ÄÏû•">${saveDayIconSVG}</button>
                            <button class="load-day-at-index-button icon-button" data-day-index="${dayIndex}" title="Ïù¥ Îã§ÏùåÏóê ÎÇ†Ïßú Î∂àÎü¨Ïò§Í∏∞">${loadDayAtIndexIconSVG}</button>
                            <button class="delete-day-button icon-button" data-day-index="${dayIndex}" title="Ïù¥ ÎÇ†Ïßú Ï†ÑÏ≤¥ ÏÇ≠Ï†ú">${deleteDayIcon}</button>
                            <button class="day-toggle-button p-1 rounded hover:bg-gray-200" data-day-index="${dayIndex}">
                                ${day.isCollapsed ? collapsedIcon : expandedIcon}
                            </button>
                        </div>
                    </div>
                    <div class="day-content-wrapper ${day.isCollapsed ? 'hidden' : ''}">
                        <div class="activities-list pt-3" data-day-index="${dayIndex}"></div>
                        <button class="add-activity-button mt-2 mb-4 ml-2 action-button bg-teal-500 text-white hover:bg-teal-600" data-day-index="${dayIndex}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Ïù¥ ÎÇ†ÏßúÏóê ÏÉà ÏùºÏ†ï Ï∂îÍ∞Ä
                        </button>
                    </div>
                `;
                daysContainer.appendChild(daySection);
                
                const activitiesList = daySection.querySelector('.activities-list');
                renderActivities(activitiesList, day.activities, dayIndex);

                if (day.editingDate) {
                    daySection.querySelector('.save-date-button').addEventListener('click', handleSaveDate);
                    daySection.querySelector('.cancel-date-edit-button').addEventListener('click', handleCancelDateEdit);
                } else {
                    daySection.querySelector('.edit-date-button').addEventListener('click', handleEditDate);
                }
                 daySection.querySelector('.day-header-container').addEventListener('click', (e) => {
                    if (!e.target.closest('input') && !e.target.closest('button')) {
                        handleToggleDayCollapse(e);
                    }
                });
                
                daySection.querySelector('.save-day-button').addEventListener('click', (e) => {
                    const dayIdx = parseInt(e.currentTarget.dataset.dayIndex);
                    handleSaveDayAsHtml(dayIdx);
                });
                daySection.querySelector('.load-day-at-index-button').addEventListener('click', (e) => {
                    insertDayAtIndex = parseInt(e.currentTarget.dataset.dayIndex) + 1; 
                    loadDayAtIndexHtmlInput.click();
                });
                daySection.querySelector('.delete-day-button').addEventListener('click', (e) => {
                    const dayIdx = parseInt(e.currentTarget.dataset.dayIndex);
                    showConfirmDeleteDayModal(dayIdx);
                });
                daySection.querySelector('.day-toggle-button').addEventListener('click', handleToggleDayCollapse);
                daySection.querySelector('.add-activity-button').addEventListener('click', handleOpenActivityModalForNew);

                new Sortable(activitiesList, { animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', handle: '.activity-card', onEnd: function (evt) { const dayIdx = parseInt(evt.from.dataset.dayIndex); const oldIndex = evt.oldDraggableIndex; const newIndex = evt.newDraggableIndex; if (oldIndex !== undefined && newIndex !== undefined && oldIndex !== newIndex) { const item = tripData.days[dayIdx].activities.splice(oldIndex, 1)[0]; tripData.days[dayIdx].activities.splice(newIndex, 0, item); } } });
            });
            
            if (daysContainer.children.length > 0 && !daysContainer.sortableInstance) {
                 daysContainer.sortableInstance = new Sortable(daysContainer, {
                    animation: 200,
                    ghostClass: 'day-section-ghost', 
                    handle: '.day-header-container', 
                    onEnd: function(evt) {
                        const oldIndex = evt.oldDraggableIndex;
                        const newIndex = evt.newDraggableIndex;

                        if (oldIndex !== undefined && newIndex !== undefined && oldIndex !== newIndex) {
                            const movedDay = tripData.days.splice(oldIndex, 1)[0];
                            tripData.days.splice(newIndex, 0, movedDay);
                            recalculateAllDates();
                            renderTrip(); 
                        }
                    }
                });
            } else if (daysContainer.children.length === 0 && daysContainer.sortableInstance) {
                daysContainer.sortableInstance.destroy();
                daysContainer.sortableInstance = null;
            }
        }

        function renderActivities(activitiesListElement, activities, dayIndex) {
            activitiesListElement.innerHTML = ''; 
            activities.forEach((activity) => { 
                const card = document.createElement('div');
                card.className = 'activity-card'; 
                card.setAttribute('data-activity-id', activity.id);
                let imageHTML = '';
                if (activity.imageUrl) { imageHTML = `<img src="${activity.imageUrl}" alt="${activity.title || 'ÌôúÎèô Ïù¥ÎØ∏ÏßÄ'}" class="card-image" onerror="this.style.display='none';">`; }
                card.innerHTML = `
                    <div class="card-time-icon-area">
                        ${activity.icon ? `<div class="card-icon">${activity.icon}</div>` : '<div class="card-icon" style="height: 28.8px;"></div>'} 
                        <div class="card-time">${formatTimeToHHMM(activity.time)}</div>
                    </div>
                    <div class="card-details-area">
                        <div class="card-title">${activity.title}</div>
                        ${activity.description ? `<div class="card-description">${activity.description}</div>` : ''}
                        ${imageHTML} 
                        ${activity.locationLink ? `<div class="card-location">üìç <a href="${activity.locationLink}" target="_blank" rel="noopener noreferrer">ÏúÑÏπò Î≥¥Í∏∞</a></div>` : ''}
                        ${activity.cost ? `<div class="card-cost">üí∞ ${activity.cost}</div>` : ''}
                        ${activity.notes ? `<div class="card-notes">üìù ${activity.notes}</div>` : ''}
                    </div>
                    <div class="card-actions-direct">
                        <button class="icon-button card-action-icon-button edit-activity-button" data-day-index="${dayIndex}" data-activity-id="${activity.id}" title="ÏàòÏ†ï">${editIconSVG}</button>
                        <button class="icon-button card-action-icon-button duplicate-activity-button" data-day-index="${dayIndex}" data-activity-id="${activity.id}" title="Î≥µÏ†ú">${duplicateIconSVG}</button>
                        <button class="icon-button card-action-icon-button delete-activity-button" data-day-index="${dayIndex}" data-activity-id="${activity.id}" title="ÏÇ≠Ï†ú">${deleteIconSVG}</button>
                    </div>`;
                activitiesListElement.appendChild(card);
            });
            activitiesListElement.querySelectorAll('.edit-activity-button').forEach(button => { button.addEventListener('click', handleOpenActivityModalForEdit); });
            activitiesListElement.querySelectorAll('.delete-activity-button').forEach(button => { button.addEventListener('click', handleDeleteActivity); });
            activitiesListElement.querySelectorAll('.duplicate-activity-button').forEach(button => { button.addEventListener('click', handleDuplicateActivity); });
        }
        
        // --- Trip Title Editing Handlers ---
        function handleEditTripTitle() { tripData.editingTitle = true; renderHeaderTitle(); }
        function handleSaveTripTitle() { const titleInput = document.getElementById('tripTitleInput'); if (titleInput && titleInput.value.trim() !== "") { tripData.title = titleInput.value.trim(); } tripData.editingTitle = false; renderHeaderTitle(); document.body.setAttribute('data-trip-title', tripData.title); }
        function handleCancelTripTitleEdit() { tripData.editingTitle = false; renderHeaderTitle(); }

        // --- Date Editing and Recalculation ---
        function recalculateAllDates() {
            if (tripData.days.length > 0) {
                let currentDate = new Date(tripData.days[0].date);
                tripData.days[0].date = dateToYyyyMmDd(currentDate); 

                for (let i = 1; i < tripData.days.length; i++) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    tripData.days[i].date = dateToYyyyMmDd(currentDate);
                }
            }
        }

        function handleEditDate(event) { const dayIndex = parseInt(event.currentTarget.dataset.dayIndex); tripData.days.forEach((day, index) => { day.editingDate = (index === dayIndex); }); renderTrip(); }
        function handleSaveDate(event) { 
            const dayIndex = parseInt(event.currentTarget.dataset.dayIndex); 
            const dateInput = document.querySelector(`.date-edit-input[data-day-index="${dayIndex}"]`); 
            if (dateInput && dateInput.value) { 
                tripData.days[dayIndex].date = dateInput.value; 
                tripData.days[dayIndex].editingDate = false; 
                recalculateAllDates(); 
            } else { 
                tripData.days[dayIndex].editingDate = false; 
            } 
            renderTrip(); 
        }
        function handleCancelDateEdit(event) { const dayIndex = parseInt(event.currentTarget.dataset.dayIndex); tripData.days[dayIndex].editingDate = false; renderTrip(); }
        function handleToggleDayCollapse(event) { 
            const dayHeaderContainer = event.target.closest('.day-header-container');
            if (!dayHeaderContainer) return; 
            
            const dayIndexElement = dayHeaderContainer.querySelector('[data-day-index]');
            if (!dayIndexElement) return;
            const dayIndex = parseInt(dayIndexElement.dataset.dayIndex);
            
            const day = tripData.days[dayIndex]; 
            if (day.editingDate) return; 
            
            const dayContentWrapper = dayHeaderContainer.nextElementSibling; 
            const toggleButtonElement = dayHeaderContainer.querySelector('.day-toggle-button'); 
            const expandedIcon = `<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`; 
            const collapsedIcon = `<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`; 
            
            day.isCollapsed = !day.isCollapsed; 
            if (dayContentWrapper) dayContentWrapper.classList.toggle('hidden', day.isCollapsed); 
            if (toggleButtonElement) { toggleButtonElement.innerHTML = day.isCollapsed ? collapsedIcon : expandedIcon; } 
        }


        // --- Activity Modal Logic ---
        function handleOpenActivityModalForNew(event) { const dayIdx = event.currentTarget.dataset.dayIndex; modalTitle.textContent = 'ÏÉà ÏùºÏ†ï Ï∂îÍ∞Ä'; activityForm.reset(); populateIconDropdown(); activityIconSelect.value = travelEmojis[0].value; activityTimeInput.value = ''; activityIdInput.value = ''; dayIndexInput.value = dayIdx; activityModal.classList.remove('hidden'); }
        function handleOpenActivityModalForEdit(event) { const button = event.currentTarget; const dayIdx = button.dataset.dayIndex; const activityIdToEdit = button.dataset.activityId; const activity = tripData.days[dayIdx].activities.find(act => act.id === activityIdToEdit); if (activity) { modalTitle.textContent = 'ÏùºÏ†ï ÏàòÏ†ï'; activityForm.reset(); populateIconDropdown(); activityIdInput.value = activity.id; dayIndexInput.value = dayIdx; activityTimeInput.value = activity.time || ""; activityIconSelect.value = activity.icon || ""; document.getElementById('activityTitle').value = activity.title || ""; document.getElementById('activityDescription').value = activity.description || ""; document.getElementById('activityLocation').value = activity.locationLink || ""; document.getElementById('activityImageUrl').value = activity.imageUrl || ""; document.getElementById('activityCost').value = activity.cost || ""; document.getElementById('activityNotes').value = activity.notes || ""; activityModal.classList.remove('hidden'); } }
        
        activityTimeInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, ''); 
            if (value.length > 4) { value = value.substring(0, 4); }
            e.target.value = value;
        });

        activityForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            const dayIdx = parseInt(dayIndexInput.value); 
            const currentActivityId = activityIdInput.value; 
            let timeValue = activityTimeInput.value.trim();
            if (timeValue.length > 0 && (timeValue.length !== 4 || !/^\d{4}$/.test(timeValue))) { alert("ÏãúÍ∞ÑÏùÄ HHMM ÌòïÏãùÏùò 4ÏûêÎ¶¨ Ïà´ÏûêÎ°ú ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÎπÑÏõåÎëêÏÑ∏Ïöî. (Ïòà: 0930 ÎòêÎäî 1700)"); return; }
            if (timeValue.length === 4) { const hours = parseInt(timeValue.substring(0, 2), 10); const minutes = parseInt(timeValue.substring(2, 4), 10); if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) { alert("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏãúÍ∞ÑÏûÖÎãàÎã§. HHÎäî 00-23, MMÏùÄ 00-59 ÏÇ¨Ïù¥Î°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."); return; } }
            const activityData = { id: currentActivityId || generateId(), time: timeValue, icon: activityIconSelect.value, title: document.getElementById('activityTitle').value, description: document.getElementById('activityDescription').value, locationLink: document.getElementById('activityLocation').value, imageUrl: document.getElementById('activityImageUrl').value, cost: document.getElementById('activityCost').value, notes: document.getElementById('activityNotes').value, }; 
            if (currentActivityId) { const activityIndex = tripData.days[dayIdx].activities.findIndex(act => act.id === currentActivityId); if (activityIndex > -1) { tripData.days[dayIdx].activities[activityIndex] = activityData; } } else { tripData.days[dayIdx].activities.push(activityData); } 
            activityModal.classList.add('hidden'); 
            renderTrip(); 
        });
        document.getElementById('cancelActivityButton').addEventListener('click', () => { activityModal.classList.add('hidden'); });

        // --- Day Management ---
        addDayButton.addEventListener('click', () => { 
            let newDate; 
            if (tripData.days.length > 0) { 
                const lastDate = new Date(tripData.days[tripData.days.length - 1].date); 
                newDate = new Date(lastDate);
                newDate.setDate(lastDate.getDate() + 1); 
            } else { 
                newDate = new Date(); 
            } 
            const newDay = { date: dateToYyyyMmDd(newDate), activities: [], isCollapsed: false, editingDate: false }; 
            tripData.days.push(newDay); 
            recalculateAllDates();
            renderTrip(); 
        });
        
        function showConfirmDeleteDayModal(dayIdx) { dayIndexToDelete = dayIdx; const dayNumber = dayIdx + 1; const dateString = new Date(tripData.days[dayIdx].date).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' }); confirmDeleteDayMessage.textContent = `DAY ${dayNumber} (${dateString})Ïùò Î™®Îì† ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`; confirmDeleteDayModal.classList.remove('hidden'); }
        function hideConfirmDeleteDayModal() { confirmDeleteDayModal.classList.add('hidden'); dayIndexToDelete = -1; }
        confirmDeleteDayActionButton.addEventListener('click', () => { if (dayIndexToDelete > -1 && dayIndexToDelete < tripData.days.length) { tripData.days.splice(dayIndexToDelete, 1); recalculateAllDates(); renderTrip(); } hideConfirmDeleteDayModal(); });
        cancelDeleteDayButton.addEventListener('click', hideConfirmDeleteDayModal);
        function handleDeleteActivity(event) { const button = event.currentTarget; const dayIdx = button.dataset.dayIndex; const activityIdToDelete = button.dataset.activityId; const userConfirmedDelete = true; if (userConfirmedDelete) { tripData.days[dayIdx].activities = tripData.days[dayIdx].activities.filter(act => act.id !== activityIdToDelete); renderTrip(); } }
        function handleDuplicateActivity(event) { const button = event.currentTarget; const dayIdx = parseInt(button.dataset.dayIndex); const activityIdToDuplicate = button.dataset.activityId; const activityToDuplicate = tripData.days[dayIdx].activities.find(act => act.id === activityIdToDuplicate); if (activityToDuplicate) { const newActivity = { ...activityToDuplicate, id: generateId(), title: `${activityToDuplicate.title} (Î≥µÏÇ¨Î≥∏)` }; const originalIndex = tripData.days[dayIdx].activities.findIndex(act => act.id === activityIdToDuplicate); tripData.days[dayIdx].activities.splice(originalIndex + 1, 0, newActivity); renderTrip(); } }

        // --- Function to generate Read-Only HTML View String for a single day ---
        function generateReadOnlyDayView(dayData, dayNumber) {
            let activitiesHTML = '';
            dayData.activities.forEach(activity => {
                let imageHTML = '';
                if (activity.imageUrl) { imageHTML = `<img src="${activity.imageUrl}" alt="${activity.title || 'ÌôúÎèô Ïù¥ÎØ∏ÏßÄ'}" class="card-image" onerror="this.style.display='none';">`; }
                activitiesHTML += `
                    <div class="readonly-activity-card">
                        <div class="card-time-icon-area">
                             ${activity.icon ? `<div class="card-icon">${activity.icon}</div>` : '<div class="card-icon" style="height: 28.8px;"></div>'}
                            <div class="card-time">${formatTimeToHHMM(activity.time)}</div>
                        </div>
                        <div class="card-details-area">
                            <div class="card-title">${activity.title}</div>
                            ${activity.description ? `<div class="card-description">${activity.description}</div>` : ''}
                            ${imageHTML}
                            ${activity.locationLink ? `<div class="card-location">üìç <a href="${activity.locationLink}" target="_blank" rel="noopener noreferrer">ÏúÑÏπò Î≥¥Í∏∞</a></div>` : ''}
                            ${activity.cost ? `<div class="card-cost">üí∞ ${activity.cost}</div>` : ''}
                            ${activity.notes ? `<div class="card-notes">üìù ${activity.notes}</div>` : ''}
                        </div>
                    </div>`;
            });
            const dayHeaderId = `day-header-readonly-single-${dayNumber}`; // Unique ID for single day view
            return `
                <div class="day-section bg-white shadow-sm rounded-md">
                    <div class="day-header-container" id="${dayHeaderId}">
                        <div class="day-header-main">
                            <h2 class="day-header-title">${formatDate(dayData.date, dayNumber)}</h2>
                        </div>
                    </div>
                    <div class="day-content-wrapper">
                        <div class="activities-list pt-3">
                            ${activitiesHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- Function to generate Read-Only HTML View String for the entire trip ---
        function generateReadOnlyHTMLView(data) {
            let daysHTML = '';
            data.days.forEach((day, dayIndex) => {
                let activitiesHTML = '';
                day.activities.forEach(activity => {
                    let imageHTML = '';
                    if (activity.imageUrl) { imageHTML = `<img src="${activity.imageUrl}" alt="${activity.title || 'ÌôúÎèô Ïù¥ÎØ∏ÏßÄ'}" class="card-image" onerror="this.style.display='none';">`; }
                    activitiesHTML += `
                        <div class="readonly-activity-card">
                            <div class="card-time-icon-area">
                                ${activity.icon ? `<div class="card-icon">${activity.icon}</div>` : '<div class="card-icon" style="height: 28.8px;"></div>'}
                                <div class="card-time">${formatTimeToHHMM(activity.time)}</div>
                            </div>
                            <div class="card-details-area">
                                <div class="card-title">${activity.title}</div>
                                ${activity.description ? `<div class="card-description">${activity.description}</div>` : ''}
                                ${imageHTML}
                                ${activity.locationLink ? `<div class="card-location">üìç <a href="${activity.locationLink}" target="_blank" rel="noopener noreferrer">ÏúÑÏπò Î≥¥Í∏∞</a></div>` : ''}
                                ${activity.cost ? `<div class="card-cost">üí∞ ${activity.cost}</div>` : ''}
                                ${activity.notes ? `<div class="card-notes">üìù ${activity.notes}</div>` : ''}
                            </div>
                        </div>`;
                });
                const expandedIcon = `<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                const collapsedIcon = `<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                const isDayCollapsedInSavedView = true; // Default to collapsed for multi-day view
                const dayHeaderId = `day-header-readonly-trip-${dayIndex}`;


                daysHTML += `
                    <div class="day-section bg-white shadow-sm rounded-md">
                        <div class="day-header-container" id="${dayHeaderId}" onclick="toggleDayView(this)">
                            <div class="day-header-main">
                                <h2 class="day-header-title">${formatDate(day.date, dayIndex + 1)}</h2>
                            </div>
                            <div class="day-header-controls">
                                <span class="day-toggle-button-static p-1 rounded">
                                     ${isDayCollapsedInSavedView ? collapsedIcon : expandedIcon}
                                </span>
                            </div>
                        </div>
                        <div class="day-content-wrapper ${isDayCollapsedInSavedView ? 'hidden' : ''}">
                            <div class="activities-list pt-3">
                                ${activitiesHTML}
                            </div>
                             <div class="text-right p-2 mt-2">
                                <button type="button" class="readonly-collapse-button" onclick="document.getElementById('${dayHeaderId}').click(); event.stopPropagation();">
                                    ÏùºÏ∞® Ï†ëÍ∏∞
                                </button>
                            </div>
                        </div>
                    </div>`;
            });
            return `
                <header class="readonly-view-header">
                    <h1>${data.title}</h1>
                </header>
                <main class="readonly-main-content saved-html-view">
                    <div id="daysContainerReadOnly">
                        ${daysHTML}
                    </div>
                </main>`;
        }
        
        // --- PDF, HTML Save/Load ---
        previewButton.addEventListener('click', () => {
            const originalCollapseStates = tripData.days.map(d => d.isCollapsed);
            const originalEditingStates = tripData.days.map(d => d.editingDate);
            const originalEditingTitleState = tripData.editingTitle;

            // For preview, keep the current collapse state from tripData for a more accurate preview
            // tripData.days.forEach(d => { d.isCollapsed = false; d.editingDate = false; }); 
            tripData.editingTitle = false; // Ensure title is not in edit mode for preview
            renderHeaderTitle(); // Update header display before generating HTML
            
            const readOnlyViewHTML = generateReadOnlyHTMLView(tripData); // Pass current tripData
            let styles = "";
            document.querySelectorAll('style').forEach(styleTag => { styles += styleTag.innerHTML; });
            const tailwindCDN = '<script src="https://cdn.tailwindcss.com"><\/script>';
            const googleFontLink = '<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">';
            
            const previewHTML = `
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Ïó¨Ìñâ ÏùºÏ†ï ÎØ∏Î¶¨Î≥¥Í∏∞: ${tripData.title}</title>
                    ${tailwindCDN}
                    ${googleFontLink}
                    <style>
                        body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8F9FA; }
                        ${styles}
                        .day-header-container[onclick] { cursor: pointer; }
                        .day-header-container[onclick]:hover { background-color: #f0f0f0; }
                    </style>
                </head>
                <body class="text-gray-800">
                    ${readOnlyViewHTML}
                    <script>
                        function toggleDayView(headerElement) {
                            const contentWrapper = headerElement.nextElementSibling;
                            const toggleButtonSpan = headerElement.querySelector('.day-toggle-button-static');
                            if (contentWrapper && toggleButtonSpan) {
                                const isHidden = contentWrapper.classList.toggle('hidden');
                                const expandedIconHTML = '<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                                const collapsedIconHTML = '<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>';
                                toggleButtonSpan.innerHTML = isHidden ? collapsedIconHTML : expandedIconHTML;
                            }
                        }
                    <\/script>
                </body>
                </html>`;

            const previewWindow = window.open('', '_blank');
            if (previewWindow) {
                previewWindow.document.write(previewHTML);
                previewWindow.document.close();
            } else {
                alert("ÌåùÏóÖÏù¥ Ï∞®Îã®ÎêòÏóàÏùÑ Ïàò ÏûàÏäµÎãàÎã§. ÎØ∏Î¶¨Î≥¥Í∏∞ Ï∞ΩÏùÑ Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§.");
            }

            // Revert to original states for the main app if they were changed for preview generation
            // tripData.days.forEach((d, i) => { 
            //     d.isCollapsed = originalCollapseStates[i]; 
            //     d.editingDate = originalEditingStates[i];
            // });
            // tripData.editingTitle = originalEditingTitleState;
            // renderTrip(); // Re-render if state was changed
        });


        savePdfButton.addEventListener('click', () => { const originalCollapseStates = tripData.days.map(d => d.isCollapsed); const originalEditingStates = tripData.days.map(d => d.editingDate); tripData.days.forEach(d => { d.isCollapsed = false; d.editingDate = false; }); tripData.editingTitle = false; renderTrip(); setTimeout(() => { window.print(); tripData.days.forEach((d, i) => { d.isCollapsed = originalCollapseStates[i]; d.editingDate = originalEditingStates[i]; }); renderTrip(); }, 100); });
        
        saveHtmlButton.addEventListener('click', () => {
            const tripDataToSave = JSON.parse(JSON.stringify(tripData)); // Create a deep copy
            // Ensure all days are marked as collapsed for the saved HTML view by default
            tripDataToSave.days.forEach(day => day.isCollapsed = true);
            tripDataToSave.editingTitle = false; // Ensure title is not in edit mode

            const tripDataString = JSON.stringify(tripData); // Save original tripData for re-import
            const safeTripDataString = tripDataString.replace(/<\/script>/g, '<\\/script>');
            const readOnlyViewHTML = generateReadOnlyHTMLView(tripDataToSave); // Generate view with all days collapsed

            let styles = "";
            document.querySelectorAll('style').forEach(styleTag => { styles += styleTag.innerHTML; });
            const tailwindCDN = '<script src="https://cdn.tailwindcss.com"><\/script>';
            const googleFontLink = '<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">';
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Ïó¨Ìñâ ÏùºÏ†ï: ${tripData.title}</title>
                    ${tailwindCDN}
                    ${googleFontLink}
                    <style>
                        body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8F9FA; }
                        ${styles}
                        .day-header-container[onclick] { cursor: pointer; }
                        .day-header-container[onclick]:hover { background-color: #f0f0f0; }
                    </style>
                </head>
                <body class="text-gray-800">
                    ${readOnlyViewHTML}
                    <script type="application/json" id="embeddedTripData">
                        ${safeTripDataString}
                    <\/script>
                    <script>
                        function toggleDayView(headerElement) {
                            const contentWrapper = headerElement.nextElementSibling;
                            const toggleButtonSpan = headerElement.querySelector('.day-toggle-button-static');
                            if (contentWrapper && toggleButtonSpan) {
                                const isHidden = contentWrapper.classList.toggle('hidden');
                                const expandedIconHTML = '<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                                const collapsedIconHTML = '<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>';
                                toggleButtonSpan.innerHTML = isHidden ? collapsedIconHTML : expandedIconHTML;
                            }
                        }
                    <\/script>
                </body>
                </html>`;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const fileName = `Ïó¨ÌñâÏùºÏ†ï_${tripData.title.replace(/[^a-z0-9Í∞Ä-Ìû£]/gi, '_')}_${dateToYyyyMmDd(new Date())}.html`;
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            toast.textContent = 'ÏùΩÍ∏∞ Ï†ÑÏö© HTML ÌååÏùºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        });

        loadHtmlButtonTrigger.addEventListener('click', () => { loadHtmlInput.click(); });
        loadHtmlInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const htmlString = e.target.result;
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlString, "text/html");
                        const embeddedDataElement = doc.getElementById('embeddedTripData');
                        if (embeddedDataElement && embeddedDataElement.textContent) {
                            const loadedData = JSON.parse(embeddedDataElement.textContent);
                            if (loadedData && loadedData.title && Array.isArray(loadedData.days)) {
                                tripData = loadedData;
                                if (typeof tripData.editingTitle === 'undefined') { 
                                    tripData.editingTitle = false;
                                }
                                tripData.days.forEach(day => { 
                                    if (typeof day.editingDate === 'undefined') day.editingDate = false;
                                    // isCollapsed state should be preserved from the loaded file for the main app
                                    if (typeof day.isCollapsed === 'undefined') day.isCollapsed = false; 
                                });
                                renderTrip(); 
                                toast.textContent = 'HTML ÌååÏùºÏóêÏÑú ÏùºÏ†ïÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§.';
                            } else { throw new Error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏûÖÎãàÎã§.'); }
                        } else { throw new Error('HTML ÌååÏùºÏóêÏÑú Ïó¨Ìñâ ÏùºÏ†ï Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ïù¥ ÌååÏùºÏùÄ Ìé∏ÏßëÏö©ÏúºÎ°ú Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.'); }
                    } catch (err) { console.error("HTML Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:", err); toast.textContent = `Ïò§Î•ò: ${err.message}`; toast.style.backgroundColor = 'red';
                    } finally { toast.classList.remove('opacity-0'); setTimeout(() => { toast.classList.add('opacity-0'); toast.style.backgroundColor = ''; }, 3000); loadHtmlInput.value = null; }
                };
                reader.onerror = () => { toast.textContent = 'ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'; toast.style.backgroundColor = 'red'; toast.classList.remove('opacity-0'); setTimeout(() => { toast.classList.add('opacity-0'); toast.style.backgroundColor = ''; }, 3000); loadHtmlInput.value = null; };
                reader.readAsText(file);
            }
        });

        // --- Individual Day Save/Load ---
        function handleSaveDayAsHtml(dayIndex) {
            if (dayIndex < 0 || dayIndex >= tripData.days.length) return;
            const dayDataToSave = JSON.parse(JSON.stringify(tripData.days[dayIndex])); 
            // For single day save, ensure it's not collapsed in its own view
            // dayDataToSave.isCollapsed = false; // Or remove this line if you want to save its current state

            const dayDataString = JSON.stringify(dayDataToSave);
            const safeDayDataString = dayDataString.replace(/<\/script>/g, '<\\/script>');
            
            const dayNumberForView = dayIndex + 1; 
            const readOnlyDayViewHTML = generateReadOnlyDayView(dayDataToSave, dayNumberForView); 
            
            let styles = "";
            document.querySelectorAll('style').forEach(styleTag => { styles += styleTag.innerHTML; });
            const tailwindCDN = '<script src="https://cdn.tailwindcss.com"><\/script>';
            const googleFontLink = '<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">';

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="ko">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>DAY ${dayNumberForView} ÏùºÏ†ï (${dayDataToSave.date})</title>
                    ${tailwindCDN}
                    ${googleFontLink}
                    <style>
                        body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8F9FA; }
                        ${styles}
                        .readonly-view-header h1 { font-size: 1.25rem; } 
                        /* Ensure day content is visible for single day save */
                        .saved-html-view .day-content-wrapper { display: block !important; }
                        .saved-html-view .day-header-controls .day-toggle-button-static { display: none !important; } /* Hide toggle for single day view */
                    </style>
                </head>
                <body class="text-gray-800">
                    <header class="readonly-view-header">
                         <h1>DAY ${dayNumberForView} : ${new Date(dayDataToSave.date).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}</h1>
                    </header>
                    <main class="readonly-main-content saved-html-view">
                        ${readOnlyDayViewHTML}
                    </main>
                    <script type="application/json" id="embeddedTripDayData">
                        ${safeDayDataString}
                    <\/script>
                </body>
                </html>`;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const fileName = `DAY${dayIndex + 1}_${dayDataToSave.date}_ÏùºÏ†ï.html`;
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            
            toast.textContent = `DAY ${dayIndex + 1} ÏùºÏ†ïÏù¥ HTML ÌååÏùºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        // Event listener for the new "load day at index" file input
        loadDayAtIndexHtmlInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && insertDayAtIndex !== -1) { 
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const htmlString = e.target.result;
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlString, "text/html");
                        const embeddedDataElement = doc.getElementById('embeddedTripDayData');

                        if (embeddedDataElement && embeddedDataElement.textContent) {
                            const loadedDayData = JSON.parse(embeddedDataElement.textContent);
                            if (loadedDayData && loadedDayData.date && Array.isArray(loadedDayData.activities)) {
                                const newDayData = {
                                    ...loadedDayData,
                                    activities: loadedDayData.activities.map(act => ({...act, id: generateId()})), 
                                    isCollapsed: false,
                                    editingDate: false
                                };
                                tripData.days.splice(insertDayAtIndex, 0, newDayData);
                                recalculateAllDates();
                                renderTrip();
                                toast.textContent = 'Ï†ÄÏû•Îêú ÎÇ†ÏßúÎ•º ÌòÑÏû¨ ÏúÑÏπò Îã§ÏùåÏóê ÏÇΩÏûÖÌñàÏäµÎãàÎã§.';
                            } else {
                                throw new Error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏûÖÎãàÎã§.');
                            }
                        } else {
                            throw new Error('HTML ÌååÏùºÏóêÏÑú ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        }
                    } catch (err) {
                        console.error("ÎÇ†Ïßú HTML Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:", err);
                        toast.textContent = `Ïò§Î•ò: ${err.message}`;
                        toast.style.backgroundColor = 'red';
                    } finally {
                        toast.classList.remove('opacity-0');
                        setTimeout(() => {
                            toast.classList.add('opacity-0');
                            toast.style.backgroundColor = ''; 
                        }, 3000);
                        loadDayAtIndexHtmlInput.value = null; 
                        insertDayAtIndex = -1; 
                    }
                };
                reader.onerror = () => { 
                    toast.textContent = 'ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'; 
                    toast.style.backgroundColor = 'red'; 
                    toast.classList.remove('opacity-0'); 
                    setTimeout(() => { toast.classList.add('opacity-0'); toast.style.backgroundColor = ''; }, 3000); 
                    loadDayAtIndexHtmlInput.value = null;
                    insertDayAtIndex = -1; 
                };
                reader.readAsText(file);
            } else {
                 insertDayAtIndex = -1; 
            }
        });

        // --- Excel Load Logic ---
        loadExcelButtonTrigger.addEventListener('click', () => {
            loadExcelInput.click();
        });

        loadExcelInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array', cellDates: true, dateNF:'yyyy-mm-dd'}); 
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false, defval: ""}); 

                        if (jsonData.length < 2) { 
                            throw new Error("ÏóëÏÖÄ ÌååÏùºÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò Ìó§ÎçîÎßå Ï°¥Ïû¨Ìï©ÎãàÎã§.");
                        }

                        const newDaysData = [];
                        let currentDayObject = null;
                        let errors = [];

                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const excelRowNumber = i + 1; 

                            const rawDate = row[0] ? String(row[0]).trim() : "";
                            const time = row[1] ? String(row[1]).trim().padStart(4, '0') : ""; 
                            const title = row[2] ? String(row[2]).trim() : "";
                            const description = row[3] ? String(row[3]).trim() : "";
                            const icon = row[4] ? String(row[4]).trim() : "";
                            const locationLink = row[5] ? String(row[5]).trim() : ""; // FÏó¥: Íµ¨Í∏Ä URL
                            const imageUrl = row[6] ? String(row[6]).trim() : "";     // GÏó¥: Ïù¥ÎØ∏ÏßÄ URL
                            const cost = row[7] ? String(row[7]).trim() : "";         // HÏó¥: ÎπÑÏö©
                            const notes = row[8] ? String(row[8]).trim() : "";        // IÏó¥: Í∏∞ÌÉÄ Î©îÎ™®


                            let formattedDate = "";
                            if (!rawDate) {
                                errors.push(`${excelRowNumber}Ìñâ: ÎÇ†Ïßú(AÏó¥)Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§. Ïù¥ ÌñâÏùÑ Í±¥ÎÑà<0xEBÎõ∞ÎãàÎã§>.`);
                                continue; 
                            }
                            let parsedDate = null;
                            if (typeof rawDate === 'number') { 
                                parsedDate = XLSX.SSF.parse_date_code(rawDate);
                                if (parsedDate) {
                                     formattedDate = `${parsedDate.y}-${String(parsedDate.m).padStart(2,'0')}-${String(parsedDate.d).padStart(2,'0')}`;
                                }
                            } else if (typeof rawDate === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(rawDate)) {
                                parsedDate = new Date(rawDate + "T00:00:00"); 
                                if (!isNaN(parsedDate.getTime())) {
                                    formattedDate = rawDate;
                                }
                            }
                            
                            if (!formattedDate) {
                                errors.push(`${excelRowNumber}Ìñâ: ÎÇ†Ïßú(AÏó¥) ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§ (YYYY-MM-DD ÌïÑÏöî). Í∞í: "${row[0]}". Ïù¥ ÌñâÏùÑ Í±¥ÎÑà<0xEBÎõ∞ÎãàÎã§>.`);
                                continue;
                            }

                            if (!title) {
                                errors.push(`${excelRowNumber}Ìñâ: ÌôúÎèô/Ïû•ÏÜåÎ™Ö(CÏó¥)Ïù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§. Ïù¥ ÌñâÏùÑ Í±¥ÎÑà<0xEBÎõ∞ÎãàÎã§>.`);
                                continue;
                            }

                            if (time && (!/^\d{4}$/.test(time) || parseInt(time.substring(0,2)) > 23 || parseInt(time.substring(2,4)) > 59 )) {
                                errors.push(`${excelRowNumber}Ìñâ: ÏãúÍ∞Ñ(BÏó¥)ÏùÄ HHMM ÌòïÏãùÏù¥Í±∞ÎÇò ÎπÑÏõåÏïº Ìï©ÎãàÎã§. Í∞í: "${row[1]}". ÏãúÍ∞Ñ Ï†ïÎ≥¥ ÏóÜÏù¥ ÏßÑÌñâÌï©ÎãàÎã§.`);
                            }
                            
                            if (!currentDayObject || currentDayObject.date !== formattedDate) {
                                currentDayObject = {
                                    date: formattedDate,
                                    activities: [],
                                    isCollapsed: false,
                                    editingDate: false
                                };
                                newDaysData.push(currentDayObject);
                            }

                            currentDayObject.activities.push({
                                id: generateId(),
                                time: time,
                                icon: icon,
                                title: title,
                                description: description,
                                locationLink: locationLink, 
                                imageUrl: imageUrl,
                                cost: cost,
                                notes: notes
                            });
                        }
                        
                        if (errors.length > 0) {
                            alert("ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ï§ë Îã§Ïùå Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n\n" + errors.join("\n") + "\n\nÏú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Îßå Î∞òÏòÅÎê©ÎãàÎã§.");
                        }

                        if (newDaysData.length > 0) {
                            tripData.days = newDaysData;
                            renderTrip();
                            toast.textContent = 'ÏóëÏÖÄÏóêÏÑú ÏùºÏ†ïÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∂àÎü¨ÏôîÏäµÎãàÎã§.';
                        } else if (errors.length > 0 && newDaysData.length === 0) {
                             toast.textContent = 'ÏóëÏÖÄÏóêÏÑú Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§. Ïò§Î•òÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
                             toast.style.backgroundColor = 'orange';
                        } else {
                             toast.textContent = 'ÏóëÏÖÄ ÌååÏùºÏóê Ï≤òÎ¶¨Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.';
                             toast.style.backgroundColor = 'orange';
                        }

                    } catch (err) {
                        console.error("ÏóëÏÖÄ Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:", err);
                        toast.textContent = `ÏóëÏÖÄ ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò: ${err.message}`;
                        toast.style.backgroundColor = 'red';
                    } finally {
                        toast.classList.remove('opacity-0');
                        setTimeout(() => {
                            toast.classList.add('opacity-0');
                            toast.style.backgroundColor = ''; 
                        }, 5000);
                        loadExcelInput.value = null; 
                    }
                };
                reader.onerror = () => { /* ... */ };
                reader.readAsArrayBuffer(file); 
            }
        });


        // --- Initial Setup ---
        populateIconDropdown(); 
        renderTrip(); 
    </script>
</body>
</html>
ÔøΩ
